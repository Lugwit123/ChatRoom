# 消息路由重构说明

## 修改内容

### 1. 路由重组织
- 将所有消息相关的API从 `app/api/v1/endpoints/messages.py` 移动到 `app/routers/message_routes.py`
- 统一了API前缀为 `/api/messages`
- 按功能将API分为三个部分：私聊消息、群聊消息和消息管理

### 2. API 端点
- 私聊消息: `/api/messages/private`
  - 参数: sender, recipient, limit
  - 权限: 只能查看与自己相关的消息
- 群聊消息: `/api/messages/group/{group_name}`
  - 参数: group_name, limit
  - 权限: 必须是群组成员或管理员
- 删除消息: `/api/messages/delete`
  - 参数: message_ids
  - 权限: 只能删除自己的消息，管理员可删除所有消息

### 3. 日志增强
- 添加了详细的日志记录
- 每个操作步骤都有清晰的日志标记
- 错误日志包含完整的堆栈跟踪

### 4. 错误处理
- 添加了更详细的错误信息
- 统一了错误返回格式
- 针对不同类型的错误返回相应的HTTP状态码

## 潜在问题和注意事项

### 1. 数据库相关
- 群组消息使用动态表名，需要确保表名生成函数 `get_group_message_table_name` 正确实现
- 删除消息时需要注意事务处理，确保数据一致性

### 2. 权限检查
- 管理员权限检查可能会打开多个数据库会话，需要注意性能影响
- 群组成员检查依赖 `group.members` 列表，确保这个列表与数据库保持同步

### 3. 性能考虑
- 消息查询默认限制为50条，可能需要根据实际使用情况调整
- 对于大型群组，可能需要添加分页功能
- 考虑添加消息缓存机制

## 后续优化建议

1. 添加消息搜索功能
2. 实现消息分页
3. 添加消息编辑功能
4. 实现消息撤回功能
5. 添加消息已读状态
6. 实现消息通知机制

## 测试建议

1. 测试不同用户角色的权限
2. 测试大量消息的性能
3. 测试并发访问
4. 测试错误处理
5. 测试日志记录

## 相关文件

- `app/routers/message_routes.py`: 新的消息路由文件
- `app/main.py`: 更新了路由注册
- `app/db/schemas.py`: 消息相关的数据模型
- `app/core/auth.py`: 用户认证和权限检查
